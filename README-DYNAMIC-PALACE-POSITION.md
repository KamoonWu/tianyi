# ч┤лх╛оцЦЧцХ░хС╜холф╜Нч╜охКицАБш░ГцХ┤ф┐охдН

## щЧощвШцППш┐░

хЬич┤лх╛оцЦЧцХ░цОТчЫШч│╗ч╗Яф╕ня╝МхС╜холчЪДф╜Нч╜оф╕Нх║ФшпехЫ║хоЪхЬич┤вх╝Х0я╝МшАМцШпх║Фшпеца╣цНочФицИ╖чЪДхЖЬхОЖхЗ║чФЯх╣┤цЬИхТМцЧ╢ш╛░хКицАБшобчоЧуАВца╣цНоч┤лх╛оцЦЧцХ░чЪДчРЖшо║я╝Ъ

> хоЙхС╜холхПгшпАя╝ЪхпЕш╡╖цнгцЬИя╝Мщб║цХ░шЗ│чФЯцЬИуАВф╗ОчФЯцЬИхолф╜Нш╡╖хнРцЧ╢я╝МщАЖцХ░шЗ│чФЯцЧ╢уАВ

хС╜холчЪДф╜Нч╜оцШпчФ▒чФицИ╖чЪДхЖЬхОЖхЗ║чФЯцЬИф╗╜хТМцЧ╢ш╛░хЖ│хоЪчЪДя╝Мф╕НхРМчЪДчФицИ╖ф╝ЪцЬЙф╕НхРМчЪДхС╜холф╜Нч╜оуАВ

## хОЯхЫахИЖцЮР

хЬихОЯцЭечЪДф╗гчаБф╕ня╝М`convertToGridLayout`хЗ╜цХ░ф╜┐чФиф║ЖхЫ║хоЪчЪДхолф╜Нф╜Нч╜оцШах░Дя╝Мх░ЖхС╜холхзЛч╗ИцФ╛хЬич┤вх╝Х0чЪДф╜Нч╜оя╝Ъ

```javascript
// цаЗхЗЖчЪДхолф╜Нф╜Нч╜оцШах░Д - ш┐ЩцШпхЫ║хоЪчЪДх╕Гх▒Аца╝х╝П
const standardGridPositions = {
  'хС╜хол': 0,
  'чИ╢цпНхол': 1,
  'чжПх╛╖хол': 2,
  'чФ░хоЕхол': 3,
  'хЕДх╝Яхол': 4,
  'хоШчжДхол': 7,
  'хдлхж╗хол': 8,
  'ф║дхПЛхол': 11,
  'хнРхе│хол': 12,
  'ш┤вх╕Ыхол': 13,
  'чЦ╛хОДхол': 14,
  'ш┐Бчз╗хол': 15
};
```

ш┐Щхп╝шЗ┤цЧашо║хС╜холхоЮщЩЕх║ФшпехЬихУкф╕кхЬ░цФпф╜Нч╜оя╝МхоГхЬичХМщЭвф╕КхзЛч╗ИцШ╛чд║хЬихЫ║хоЪф╜Нч╜оуАВ

## ф┐охдНцЦ╣цбИ

цИСф╗мф┐оцФ╣ф║Ж`convertToGridLayout`хЗ╜цХ░я╝Мф╜┐хЕ╢ца╣цНохС╜холчЪДхЬ░цФпф╜Нч╜охКицАБш░ГцХ┤холф╜Нх╕Гх▒АуАВхЕ╖ф╜УхБЪц│ХцШпя╝Ъ

1. цЙ╛хИ░хС╜холхп╣х║ФчЪДхЬ░цФп
2. ца╣цНохЬ░цФпщАЙцЛйхп╣х║ФчЪДф╜Нч╜оцШах░Дшби
3. ф╜┐чФиш┐Щф╕кф╜Нч╜оцШах░ДшбицЭечбохоЪцпПф╕кхолф╜НхЬич╜Сца╝ф╕нчЪДф╜Нч╜о

## ф┐охдНцнещкд

### ф┐оцФ╣`services/palace-calculation.js`цЦЗф╗╢ф╕нчЪД`convertToGridLayout`хЗ╜цХ░

```javascript
/**
 * ца╣цНохЙНчлпх╕Гх▒АщЬАц▒Вя╝Мх░ЖхНБф║Мхолш╜мцНвф╕║4x4ч╜Сца╝х╕Гх▒А
 * @param {Array} palaces - хНБф║МхолцХ░ч╗Д
 * @returns {Array} - 16ф╕кф╜Нч╜очЪДх╕Гх▒АцХ░ч╗Дя╝ИхМЕхРлчй║ф╜Ня╝Й
 */
function convertToGridLayout(palaces) {
  // 4x4ч╜Сца╝х╕Гх▒АцШах░Дя╝Иф╕ОхЙНчлпч╗Дф╗╢ф╕АшЗ┤я╝Й- ч┤лх╛оцЦЧцХ░цаЗхЗЖх╕Гх▒А
  // щб╢шбМя╝ЪхС╜хол | чИ╢цпНхол | чжПх╛╖хол | чФ░хоЕхол
  // ф╕ншбМя╝ЪхЕДх╝Яхол | [ф╕нхолхМ║хЯЯ] | хоШчжДхол
  // ф╕ншбМя╝Ъхдлхж╗хол | [ф╕нхолхМ║хЯЯ] | ф║дхПЛхол  
  // х║ХшбМя╝ЪхнРхе│хол | ш┤вх╕Ыхол | чЦ╛хОДхол | ш┐Бчз╗хол
  
  // хИЫх╗║ф╕Аф╕к16ф╜Нч╜очЪДцХ░ч╗Дя╝МчФиф║ОхнШцФ╛х╕Гх▒АцХ░цНо
  const layoutData = new Array(16);
  
  // ф╕нхолф╜Нч╜о
  layoutData[5] = { name: '', isEmpty: true, isCenter: true, layoutIndex: 5 };
  layoutData[6] = { name: '', isEmpty: true, isCenter: true, layoutIndex: 6 };
  layoutData[9] = { name: '', isEmpty: true, isCenter: true, layoutIndex: 9 };
  layoutData[10] = { name: '', isEmpty: true, isCenter: true, layoutIndex: 10 };
  
  // цЙ╛хИ░хС╜хол
  const mingGong = palaces.find(palace => palace.name === 'хС╜хол');
  if (!mingGong) {
    console.error('тЭМ цЬкцЙ╛хИ░хС╜холя╝МцЧац│ХчФЯцИРх╕Гх▒А');
    return layoutData;
  }
  
  // шО╖хПЦхС╜холчЪДхЬ░цФп
  const mingGongBranch = mingGong.branch;
  console.log(`ЁЯФН хС╜холхЬ░цФп: ${mingGongBranch}`);
  
  // хЬ░цФпхп╣х║ФчЪДхЫ║хоЪф╜Нч╜оцШах░Д
  // ш┐ЩцШпч┤лх╛оцЦЧцХ░чЪДцаЗхЗЖх╕Гх▒Ая╝Мф╕НхРМхЬ░цФпхп╣х║Фф╕НхРМчЪДф╜Нч╜о
  const branchToPositionMap = {
    'хнР': { 'хС╜хол': 0, 'хЕДх╝Яхол': 4, 'хдлхж╗хол': 8, 'хнРхе│хол': 12, 'ш┤вх╕Ыхол': 13, 'чЦ╛хОДхол': 14, 'ш┐Бчз╗хол': 15, 'ф║дхПЛхол': 11, 'хоШчжДхол': 7, 'чФ░хоЕхол': 3, 'чжПх╛╖хол': 2, 'чИ╢цпНхол': 1 },
    'ф╕С': { 'хС╜хол': 4, 'хЕДх╝Яхол': 8, 'хдлхж╗хол': 12, 'хнРхе│хол': 13, 'ш┤вх╕Ыхол': 14, 'чЦ╛хОДхол': 15, 'ш┐Бчз╗хол': 11, 'ф║дхПЛхол': 7, 'хоШчжДхол': 3, 'чФ░хоЕхол': 2, 'чжПх╛╖хол': 1, 'чИ╢цпНхол': 0 },
    'хпЕ': { 'хС╜хол': 8, 'хЕДх╝Яхол': 12, 'хдлхж╗хол': 13, 'хнРхе│хол': 14, 'ш┤вх╕Ыхол': 15, 'чЦ╛хОДхол': 11, 'ш┐Бчз╗хол': 7, 'ф║дхПЛхол': 3, 'хоШчжДхол': 2, 'чФ░хоЕхол': 1, 'чжПх╛╖хол': 0, 'чИ╢цпНхол': 4 },
    'хНп': { 'хС╜хол': 12, 'хЕДх╝Яхол': 13, 'хдлхж╗хол': 14, 'хнРхе│хол': 15, 'ш┤вх╕Ыхол': 11, 'чЦ╛хОДхол': 7, 'ш┐Бчз╗хол': 3, 'ф║дхПЛхол': 2, 'хоШчжДхол': 1, 'чФ░хоЕхол': 0, 'чжПх╛╖хол': 4, 'чИ╢цпНхол': 8 },
    'ш╛░': { 'хС╜хол': 13, 'хЕДх╝Яхол': 14, 'хдлхж╗хол': 15, 'хнРхе│хол': 11, 'ш┤вх╕Ыхол': 7, 'чЦ╛хОДхол': 3, 'ш┐Бчз╗хол': 2, 'ф║дхПЛхол': 1, 'хоШчжДхол': 0, 'чФ░хоЕхол': 4, 'чжПх╛╖хол': 8, 'чИ╢цпНхол': 12 },
    'х╖│': { 'хС╜хол': 14, 'хЕДх╝Яхол': 15, 'хдлхж╗хол': 11, 'хнРхе│хол': 7, 'ш┤вх╕Ыхол': 3, 'чЦ╛хОДхол': 2, 'ш┐Бчз╗хол': 1, 'ф║дхПЛхол': 0, 'хоШчжДхол': 4, 'чФ░хоЕхол': 8, 'чжПх╛╖хол': 12, 'чИ╢цпНхол': 13 },
    'хНИ': { 'хС╜хол': 15, 'хЕДх╝Яхол': 11, 'хдлхж╗хол': 7, 'хнРхе│хол': 3, 'ш┤вх╕Ыхол': 2, 'чЦ╛хОДхол': 1, 'ш┐Бчз╗хол': 0, 'ф║дхПЛхол': 4, 'хоШчжДхол': 8, 'чФ░хоЕхол': 12, 'чжПх╛╖хол': 13, 'чИ╢цпНхол': 14 },
    'цЬк': { 'хС╜хол': 11, 'хЕДх╝Яхол': 7, 'хдлхж╗хол': 3, 'хнРхе│хол': 2, 'ш┤вх╕Ыхол': 1, 'чЦ╛хОДхол': 0, 'ш┐Бчз╗хол': 4, 'ф║дхПЛхол': 8, 'хоШчжДхол': 12, 'чФ░хоЕхол': 13, 'чжПх╛╖хол': 14, 'чИ╢цпНхол': 15 },
    'чФ│': { 'хС╜хол': 7, 'хЕДх╝Яхол': 3, 'хдлхж╗хол': 2, 'хнРхе│хол': 1, 'ш┤вх╕Ыхол': 0, 'чЦ╛хОДхол': 4, 'ш┐Бчз╗хол': 8, 'ф║дхПЛхол': 12, 'хоШчжДхол': 13, 'чФ░хоЕхол': 14, 'чжПх╛╖хол': 15, 'чИ╢цпНхол': 11 },
    'щЕЙ': { 'хС╜хол': 3, 'хЕДх╝Яхол': 2, 'хдлхж╗хол': 1, 'хнРхе│хол': 0, 'ш┤вх╕Ыхол': 4, 'чЦ╛хОДхол': 8, 'ш┐Бчз╗хол': 12, 'ф║дхПЛхол': 13, 'хоШчжДхол': 14, 'чФ░хоЕхол': 15, 'чжПх╛╖хол': 11, 'чИ╢цпНхол': 7 },
    'цИМ': { 'хС╜хол': 2, 'хЕДх╝Яхол': 1, 'хдлхж╗хол': 0, 'хнРхе│хол': 4, 'ш┤вх╕Ыхол': 8, 'чЦ╛хОДхол': 12, 'ш┐Бчз╗хол': 13, 'ф║дхПЛхол': 14, 'хоШчжДхол': 15, 'чФ░хоЕхол': 11, 'чжПх╛╖хол': 7, 'чИ╢цпНхол': 3 },
    'ф║е': { 'хС╜хол': 1, 'хЕДх╝Яхол': 0, 'хдлхж╗хол': 4, 'хнРхе│хол': 8, 'ш┤вх╕Ыхол': 12, 'чЦ╛хОДхол': 13, 'ш┐Бчз╗хол': 14, 'ф║дхПЛхол': 15, 'хоШчжДхол': 11, 'чФ░хоЕхол': 7, 'чжПх╛╖хол': 3, 'чИ╢цпНхол': 2 }
  };
  
  // шО╖хПЦх╜УхЙНхС╜холхЬ░цФпхп╣х║ФчЪДф╜Нч╜оцШах░Д
  const positionMap = branchToPositionMap[mingGongBranch];
  if (!positionMap) {
    console.error(`тЭМ цЬкцЙ╛хИ░хЬ░цФп ${mingGongBranch} хп╣х║ФчЪДф╜Нч╜оцШах░Д`);
    return layoutData;
  }
  
  // хдДчРЖцпПф╕кхолф╜НцХ░цНо
  palaces.forEach(palace => {
    // шО╖хПЦхолф╜НхРНчз░хп╣х║ФчЪДч╜Сца╝ф╜Нч╜о
    const gridIndex = positionMap[palace.name];
    
    if (gridIndex !== undefined) {
      // х░Жхолф╜НцХ░цНоцФ╛хЕехп╣х║ФчЪДч╜Сца╝ф╜Нч╜о
      layoutData[gridIndex] = {
        ...palace,
        displayName: palace.name, // ц╖╗хКаdisplayNameхнЧцо╡я╝МчФиф║ОхЙНчлпцШ╛чд║
        isEmpty: false,
        layoutIndex: gridIndex
      };
    }
  });
  
  return layoutData;
}
```

## ц╡ЛшпХщкМшпБ

цИСф╗мхИЫх╗║ф║Жф╕Аф╕кц╡ЛшпХшДЪцЬм`utils/test-dynamic-palace-position.js`я╝МчФиф║ОщкМшпБхС╜холф╜Нч╜оцШпхРжца╣цНохЬ░цФпхКицАБш░ГцХ┤уАВц╡ЛшпХч╗УцЮЬшбицШОя╝Ъ

1. чФицИ╖1я╝ЪхС╜холхЬиф║ехоля╝Мф╜Нф║Оч┤вх╝Х1
2. чФицИ╖2хТМчФицИ╖3я╝ЪхС╜холхЬихнРхоля╝Мф╜Нф║Оч┤вх╝Х0

ш┐ЩшпБцШОцИСф╗мчЪДф┐оцФ╣цШпцнгчбочЪДя╝МхС╜холчЪДф╜Нч╜очО░хЬица╣цНохЬ░цФпхКицАБш░ГцХ┤ф║ЖуАВ

## ч╗Ушо║

щАЪш┐Зф┐оцФ╣`convertToGridLayout`хЗ╜цХ░я╝МцИСф╗мцИРхКЯхЬ░хоЮчО░ф║ЖхС╜холф╜Нч╜оца╣цНохЬ░цФпхКицАБш░ГцХ┤чЪДхКЯшГ╜уАВш┐Щф╜┐х╛Чч┤лх╛оцЦЧцХ░цОТчЫШч│╗ч╗ЯшГ╜хдЯцЫ┤хЗЖчбохЬ░хПНцШачФицИ╖чЪДхС╜чЫШф┐бцБпя╝МцПРщлШф║Жч│╗ч╗ЯчЪДхЗЖчбоцАзхТМхПпщЭацАзуАВ 